# Аудит приложения G8 Adjumannya — системный аналитик

Документ описывает **все данные**, которыми оперирует приложение, и **основные технические концепции**. Основа для последующего аудита бизнес-аналитиком и предложений по развитию.

---

## 1. Назначение приложения

**G8 Adjumannya** — приложение для группового челленджа «100 отжиманий в день»:

- Участники добавляют результаты в **Telegram-чате** (бот) или через **WebApp**.
- Данные хранятся в **PostgreSQL**.
- Отображаются: статус за день, рекорды, календарь истории, лидерборд.

**Точки входа:**

- **Telegram-бот** — команды `/add`, `/status`, `/record`, `/correct`, `/share`, `/hide`, `/web`, `/force`, `/help`.
- **HTTP API** — REST для WebApp: v1 (токен по chat_id) и v2 (JWT по user_id).
- **WebApp (Vue 3 + Pinia)** — SPA, авторизация через initData → JWT (v2) или токен из бота (v1).

---

## 2. Данные приложения (сущности и атрибуты)

### 2.1 Пользователь (User)

| Атрибут     | Тип        | Описание |
|------------|------------|----------|
| user_id    | BIGINT, PK | Идентификатор Telegram |
| username   | TEXT       | @username в Telegram (может быть пустым) |
| first_name | TEXT       | Имя (v1; в v2 не используется) |
| last_name  | TEXT       | Фамилия (v1; в v2 не используется) |
| created_at | TIMESTAMPTZ| Дата первой регистрации |
| updated_at | TIMESTAMPTZ| Дата последнего обновления профиля |

**Источники:** создаётся/обновляется при первом взаимодействии с ботом или при `POST /api/v2/auth` (initData).  
**Отображаемое имя:** в v2 — `username` или `"User " + user_id`; в v1 — first_name/last_name/username.

---

### 2.2 Подход (Approach / daily_adds)

Один подход = одна запись «добавил N отжиманий в момент T за дату D».

| Атрибут   | Тип         | Ограничения | Описание |
|----------|-------------|-------------|----------|
| id       | BIGSERIAL, PK | — | Идентификатор подхода |
| user_id  | BIGINT, FK→users | NOT NULL | Кто добавил |
| date     | DATE        | NOT NULL, ≤ CURRENT_DATE | Дата подхода (будущие запрещены) |
| count    | INTEGER     | 1–1000      | Количество отжиманий в этом подходе |
| created_at | TIMESTAMPTZ | NOT NULL | Время добавления |
| migrated | BOOLEAN     | DEFAULT FALSE | TRUE = портировано из старой схемы, не входит в рекорды |

**Производные (без отдельных таблиц):**

- **Итог за день (user, date):** `SUM(count)` по `daily_adds` для user_id и date.
- **Лучший подход (user):** `MAX(count)` по `daily_adds` для user_id, где migrated = FALSE.
- **Лучший день (user):** дата с максимальной суммой за день по `daily_adds` (migrated = FALSE).

---

### 2.3 Связка «чат — пользователь» (shared_chats)

Определяет, в каких чатах видны результаты пользователя. Одна запись = пользователь «подключён» к чату: его подходы учитываются в статусе и рекордах этого чата.

| Атрибут    | Тип         | Описание |
|-----------|-------------|----------|
| chat_id   | BIGINT      | ID чата Telegram (часть PK) |
| user_id   | BIGINT, FK→users | Пользователь (часть PK) |
| created_at| TIMESTAMPTZ | Когда подключён |

**Участники чата:** список user_id из `shared_chats` для данного chat_id. Отдельной таблицы «участники чата» нет.

**Правила:** добавление записи — при первом `add` в чате или по команде `/share`; удаление — по команде `/hide`.

---

### 2.4 Устаревшие / вспомогательные данные

| Сущность       | Назначение | Текущее использование |
|----------------|------------|------------------------|
| **daily_counts** | Старая модель: одна строка на (chat_id, user_id, date), count обновляется на месте | Запись из бота и v1 API; чтение статуса/истории в v1 частично через неё; параллельно пишется в daily_adds |
| **user_records** | Глобальные рекорды пользователя (max_add, record_count, record_date) | Заполняется в initDb из records; чтение рекордов в v1 из user_records |
| **records**     | Устаревшая таблица рекордов по чату | Только миграция в user_records в initDb |
| **api_tokens**  | Токен доступа к API v1, привязан к chat_id | Используется только для API v1 (Bearer token → chat_id) |
| **migration_flags** | Флаги применённых миграций/бэкфиллов | name (PK), applied_at; для однократного выполнения миграций |

---

## 3. Основные технические концепции

### 3.1 Модель «подходов» (v2) vs «сумма за день» (v1)

- **v2 (целевая):** каждый факт «добавил N отжиманий» хранится отдельной строкой в `daily_adds`. Рекорды и итоги считаются агрегацией (SUM, MAX, лучший день по SUM по датам).
- **v1:** бот и старый API пишут в `daily_counts` (одна строка на (chat_id, user_id, date), count накапливается). Для совместимости при записи из бота/v1 также выполняется вставка в `daily_adds`.

### 3.2 Привязка к чату и к пользователю

- **Бот:** всегда знает chat_id и user_id из контекста сообщения. Запись идёт в «канонический» чат пользователя (`resolveWriteChatId`): если пользователь в shared_chats, пишем в чат с минимальным chat_id среди его чатов.
- **API v1:** авторизация по токену из `api_tokens` → определяется chat_id. Все запросы привязаны к чату (status, records, history по chat_id).
- **API v2:** авторизация по JWT (payload user_id). Запросы привязаны к пользователю; для status/records по чату передаётся query-параметр `chat_id`, с проверкой доступа через `shared_chats` (req.userId должен быть участником чата).

### 3.3 Даты и время

- **Дата подхода/дня:** тип DATE, формат в API `YYYY-MM-DD`. День не может быть в будущем (CHECK в daily_adds).
- **Время:** created_at, updated_at — TIMESTAMPTZ; в ответах API — ISO 8601. Рекомендуется единая таймзона (UTC) на сервере/БД.

### 3.4 Авторизация WebApp / API v2

1. Клиент отправляет Telegram WebApp `init_data` на `POST /api/v2/auth`.
2. Сервер проверяет подпись initData (HMAC-SHA256, секрет Bot API), извлекает user (id, username), создаёт/обновляет запись в `users`, выдаёт JWT с payload `{ user_id, exp }`.
3. Дальнейшие запросы с заголовком `Authorization: Bearer <jwt>`; middleware кладёт `req.userId`.

Отдельная таблица api_tokens в v2 не используется.

### 3.5 Правила доступа

- **Свои данные:** история, подходы — только свой user_id (из JWT).
- **Данные чата:** status и records по chat_id доступны только если req.userId входит в участников этого чата (`shared_chats`).
- **Редактирование/удаление подхода:** только свой подход (approach.user_id === req.userId).

### 3.6 Инварианты и ограничения

- Один подход: count от 1 до 1000; не более 100 подходов в одном POST /api/v2/add.
- Дата подхода: date ≤ CURRENT_DATE.
- Участники чата для status/records определяются только через shared_chats (для v2 и актуального чтения из daily_adds).

---

## 4. Архитектура компонентов

| Компонент | Технологии | Роль |
|-----------|------------|------|
| **Бот** | Node.js, Telegraf, session | Команды в чате, парсинг add/correct/status/record/share/hide/web/force/help, запись в БД, выдача ссылки на WebApp с токеном |
| **API** | Express, JWT (v2), api_tokens (v1) | REST: auth, add, status, records, history, approaches (GET/PATCH/DELETE); раздача статики WebApp |
| **БД** | PostgreSQL (pg), advisory lock при initDb | Таблицы users, daily_counts, daily_adds, shared_chats, api_tokens, user_records, records, migration_flags |
| **WebApp** | Vue 3, Pinia, Vite | SPA: авторизация (token/user_id из URL или initData→auth), добавление отжиманий, сегодняшние результаты с правкой/удалением подходов, лидерборд, календарь, статистика (дней участия, всего, среднее) |

**Запуск:** один процесс (server.js) может поднимать initDb, Express (API + статика) и бота; либо отдельно `start:bot` и `start:api`.

---

## 5. Потоки данных (кратко)

- **Добавление отжиманий:** бот (add) или WebApp → API add → daily_counts (v1) и daily_adds (v2 sync); при v2 add — только daily_adds.
- **Статус за дату:** запрос по chat_id (и date) → участники из shared_chats → по ним агрегация из daily_adds (v2) или daily_counts (v1) → сортировка по сумме.
- **Рекорды:** участники чата из shared_chats → по user_id из daily_adds (migrated = FALSE) считаются best_approach и best_day → сортировка.
- **История пользователя:** по user_id агрегация daily_adds (или daily_counts в v1) по датам → объект days { "YYYY-MM-DD": total }.

---

## 6. Сводка: данные и концепции для развития

- **Ядро данных:** пользователи (users), подходы (daily_adds), связка с чатами (shared_chats). Рекорды и итоги — производные от daily_adds.
- **Двойная запись:** бот/v1 продолжают писать в daily_counts и дублируют в daily_adds; чтение в новых эндпоинтах и логике — из daily_adds.
- **Два режима авторизации:** v1 по токену (chat_id), v2 по JWT (user_id); для status/records в v2 chat_id передаётся явно с проверкой через shared_chats.
- **Ограничения:** 1–1000 отжиманий в одном подходе, не более 100 подходов в одном запросе, дата не в будущем; права — только свои подходы и только чаты, где пользователь в shared_chats.

Этот документ служит основой для следующего шага: предложений бизнес-аналитика по фичам и развитию продукта.
